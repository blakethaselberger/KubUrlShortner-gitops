---
# Development ArgoCD Application
# This application manages the development deployment from overlays/dev
#
# Deployment flow:
# 1. Images are built and pushed to ECR by GitHub Actions
# 2. Dev overlay image tags are updated in the gitops repo
# 3. ArgoCD auto-syncs this application, pulling from overlays/dev
# 4. Once dev tests pass, the same images are promoted to prod
#
# Setup: kubectl apply -f argocd/application-dev.yaml -n argocd
#
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: url-shortener-dev
  namespace: argocd
spec:
  # Destination cluster and namespace
  destination:
    namespace: dev-url-shortener
    server: https://kubernetes.default.svc

  # ArgoCD project (using default)
  project: default

  # Git source configuration
  source:
    path: overlays/dev
    repoURL: https://github.com/blakethaselberger/KubUrlShortner-gitops.git
    targetRevision: HEAD

  # Sync policy - auto-sync enabled
  # This means ArgoCD will automatically deploy when git changes
  syncPolicy:
    automated:
      enabled: true
      prune: true        # Delete resources if removed from git
      selfHeal: true     # Revert manual changes
    syncOptions:
    - CreateNamespace=true  # Create dev-url-shortener namespace if it doesn't exist
